<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd" />
<head>
        <title>[% title %]</title>

        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="/css/stations.css" />
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript" /></script />
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
        <script type="text/javascript" />
        $(document).ready(function(){

                // AAACHOO!!!  Javascript, I'm alergic to you, but I'm slightly indebted to you for this:

                var active = 1;

                // timeout refresh
                $('div.error,div#error').click( function() {
                        location.reload();
                });

                // manual non-submitting toggle
                function toggleit ( toggleid ) {
                    if($('#' + toggleid)[0].checked == false) {  
                        $('#' + toggleid).removeClass('off').addClass('on');
                        $('#' + toggleid)[0].checked = true;  
                  
                    } else {
                        $('#' + toggleid)[0].checked = false;  
                        $('#' + toggleid).removeClass('on').addClass('off');  
                  
                    }  
                }

                // set initial states
                $('div.togglebox').each(function() {
                        if($(this).hasClass('on')) {
                                $($(this).id + '-toggle').slider('enable');
                                $($(this).id + '-toggle').slider('refresh');
                        } else {
                                $($(this).id + '-toggle').slider('disable');
                                $($(this).id + '-toggle').slider('refresh');
                        }
                }); // togglebox foreach

                // toggle actions
                $('div.togglebox').click(function() {
                        if ( active ) {
                                active = 0;

                        function submit (id, action) {
                                $('#' + id + '-load').css("visibility","visible");
                                $('#' + id).find('div.success,div.failure').stop(true,true).clearQueue();
                                $('#' + id).find('div.success,div.failure').hide();
                                
                                $.ajax({
                                        type: "POST",
                                        url: "/stations/:" + id,
                                        data: { grp: id, act: action },
                                        dataType: "json",
                                        //async: false,
                                        timeout: 1000, // in milliseconds
                                        success: function(data) {
                                                // process data here

                                                var status = '';

                                                switch (data.result) {
                                                        case 'success':
                                                                status = '#' + action;
                                                                toggleit(id);
                                                        case 'failure':
                                                                $('#' + id).closest('td').parent('tr').find('div.' + data.result + status).fadeIn('fast').animate({opacity:1},1000).fadeOut(1000);
                                                                active = 1;
                                                                break;
                                                        default:
                                                                $('div.fullscreen').show();
                                                                $('div.' + data.result).show().empty().append(data.msg);
                                                }

                                                $('#' + id + '-load').css({visibility: "hidden"});
                                        },
                                        error: function(request, status, err) {
                                                if (status == "timeout") {
                                                        $('div.fullscreen').show();
                                                        $('div.error').show().empty().append('REQUEST TIMED OUT<p>Refresh page or click this window to continue.');
                                                        $('#' + id).closest('td').parent('tr').find('div.loader').css({visibility: "hidden"});
                                                        active = 1;
                                                        //revert toggle
                                                }
                                        }
                                });
                        } // function submit



                            if($(this)[0].checked == false) {  
                                submit($(this).attr('id'),'on');
                          
                            } else {  
                                submit($(this).attr('id'),'off');
                          
                            }  
                        }
                }); // togglebox click

        }); // document.ready
        </script />
</head>
<body>
[% content %]
</body>
</html>
